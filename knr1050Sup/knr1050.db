record(bo, "$(P)SIM") {
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
    field(VAL, "$(RECSIM=0)")
}

###########################################################
# Disable checking
###########################################################

# ///
# /// The device can be in states were we want to suppress
# /// the ability to push set points or turn the pump ON (not 
# /// off). This record is used as an SDIS input for a number 
# /// of records.
# ///
record(bi, "$(P)DISABLE") {
    field(DESC, "Disable set points and pump start")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
	
    field(ZNAM, "Disabled")
    field(ONAM, "Enabled")	
	info(INTEREST, "HIGH")
}

record(calcout, "$(P)DISABLE:CHECK") {
	field(DESC, "Check remote mode/con sum is 100%")
	field(SCAN, "Passive")
	field(INPA, "$(P)REMOTE_MODE.RVAL CP MS")
	field(INPB, "$(P)CON:SUM CP MS")
	
	field(CALC, "A&&B=1?1:0")
	
	field(OUT, "$(P)DISABLE PP")
}

###########################################################
# Remote/Local mode control
###########################################################

# ///
# /// The device can be in a local or remote mode. If in local
# /// mode then the front panel can be accessed but no commands
# /// can be remotely executed accept for switching to remote
# /// and checking the current remote/local state. If in remote
# /// mode then remotely executed commands are accepted but the
# /// front panel of the device is unavailable.
# ///
record(bo, "$(P)REMOTE_MODE:SP") {
	field(DESC, "Set the device into remote mode")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto set_remote_mode() $(PORT)")
	field(ZNAM, "")
	field(ONAM, "Remote")
}

record(bo, "$(P)LOCAL_MODE:SP") {
	field(DESC, "Sets the device into local mode")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto set_local_mode() $(PORT)")
	field(ZNAM, "")
	field(ONAM, "Local")
}

record(bi, "$(P)GET_REMOTE_MODE") {
	field(DESC, "Gets the current remote state")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_remote_mode($(P)REMOTE_MODE) $(PORT)")
}

record(bo, "$(P)REMOTE_MODE") {
	field(DESC, "Current remote/local mode state")
	field(SCAN, "Passive")
	
	field(ZNAM, "Local")
	field(ONAM, "Remote")

	info(INTEREST, "HIGH")
}

###########################################################
# Control the pump to either begin or stop a ramp
###########################################################

# ///
# /// The pump start set point calls both a ramp command as
# /// well as a forward linked stop mode command. The stop
# /// mode keeps the last values rather than stopping the
# /// pump. If the device is in local mode, or the gradients
# /// are not correctly set, then the pump start set point is
# /// disabled.
# ///
record(bo, "$(P)PUMP:STOP:SP") {
	field(DESC, "Stops the pump")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT,  "@knr1050.proto stop_pump $(PORT)")
	field(ZNAM, "")
	field(ONAM, "Stop")
}

alias("$(P)PUMP:STOP:SP", "$(P)PUMP:STOP")

record(bo, "$(P)PUMP:START:SP") {
	field(DESC, "Starts the pump")
	field(DTYP, "stream")
    field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto ramp($(P),_FLOW:SP:CONV,CON:A:SP,CON:B:SP,CON:C:SP,CON:D:SP) $(PORT)")
	field(ZNAM, "")
	field(ONAM, "Start")

	field(FLNK, "$(P)_STOP:KLV:SP PP")
	
	field(DISV, "0")
	field(SDIS, "$(P)DISABLE")
}

alias("$(P)PUMP:START:SP", "$(P)PUMP:START")

record(bo, "$(P)_STOP:KLV:SP") {
	field(DESC, "Stop mode: keep last values")
	field(DTYP, "stream")

	field(OUT,  "@knr1050.proto stop_klv $(PORT)")
}

alias("$(P)_STOP:KLV:SP", "$(P)_STOP:KLV")

###########################################################
# Get the device status
###########################################################

# ///
# /// The status is sent to a calculation record buffer. The 
# /// records that relate to the status returns are then 
# /// populated using the buffer elements. 
# ///
record(ai, "$(P)GET_STATUS") {
	field(DESC, "Get the current device status")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_status($(P)BUFFER) $(PORT)")
	
	info(alarm, "Knr1050")
}

record(calc, "$(P)BUFFER") {
	field(DESC, "Parsed values of get_status")
	field(CALC, "0")
}

record(ai, "$(P)TIMESTAMP") {
	field(DESC, "Device time stamp in ms")
	field(EGU, "ms")
	
	field(INP, "$(P)BUFFER.A CP")
	
	info(INTEREST, "HIGH")
}

record(mbbi, "$(P)DEV_STATE") {
    field(DESC, "The current device state.")

	field(INP, "$(P)BUFFER.B CP")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
	field(FVVL, "5")
    field(SXVL, "6")   
	
    field(ZRST, "SYS_ST_INITIALIZING")
    field(ONST, "SYS_ST_OFF")
    field(TWST, "SYS_ST_IDLE")
    field(THST, "SYS_ST_RUN")
    field(FRST, "SYS_ST_HOLD")
    field(FVST, "SYS_ST_PURGE")
    field(SXST, "SYS_ST_STANDBY")
    
    info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR_ERR") {
	field(DESC, "Current error")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.C CP")
	
	info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR_PG_RT") {
	field(DESC, "Current program run time")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.D CP")
	
	info(INTEREST, "HIGH")
}

record(calcout, "$(P)_FLOW:CONV") {
	field(DESC, "Convert from uL/min to mL/min")
	field(INPA, "$(P)BUFFER.E CP")
	field(CALC, "A / 1000")
	
	field(OUT, "$(P)FLOW:CURR PP")
}

record(ai, "$(P)FLOW:CURR") {
	field(DESC, "Current flow rate")
	field(EGU, "mL/min")
	field(PREC, "3")
	
	info(INTEREST, "HIGH")
}

record(calc, "$(P)_FLOW:SP:CONV") {
	field(DESC, "Convert from ml/min to uL/min")
	field(INPA, "$(P)FLOW:SP CP")
	field(CALC, "A * 1000")
}

record(ai, "$(P)FLOW") {
	field(DESC, "Desired flow rate")
	field(EGU, "mL/min")
	field(PREC, "3")
	field(INP, "$(P)FLOW:SP CP")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:FLOW")
}

record(ao, "$(P)FLOW:SP") {
	field(DESC, "Desired flow rate")
	field(EGU, "mL/min")
	field(PREC, "3")
	
	field(DISV, "0")
	field(SDIS, "$(P)DISABLE")
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:FLOW:SP PP")
}

alias("$(P)FLOW", "$(P)FLOW:SP:RBV")

###########################################################
# Concentration gradients
###########################################################

# ///
# /// Here we calculate the sum of the 4 concentration gradients
# /// and if they exceed 100% then the disabled check is updated.
# /// This allows the user to stop the pump even if the current
# /// gradient set points are invalid. 
# ///
record(calc, "$(P)CON:SUM") {
	field(DESC, "Check the gradients sum to 100%")
	field(SCAN, "Passive")
	
	field(INPA, "$(P)CON:A:SP CP")
	field(INPB, "$(P)CON:B:SP CP")
	field(INPC, "$(P)CON:C:SP CP")
	field(INPD, "$(P)CON:D:SP CP")

	field(CALC, "(A+B+C+D)=100?1:0")
}

record(calc, "$(P)CON:SUM:VAL") {
	field(DESC, "Sum the gradients")
	field(SCAN, "Passive")
	
	field(INPA, "$(P)CON:A:SP CP")
	field(INPB, "$(P)CON:B:SP CP")
	field(INPC, "$(P)CON:C:SP CP")
	field(INPD, "$(P)CON:D:SP CP")

	field(CALC, "A+B+C+D")
}

record(ai, "$(P)CON:A") {
	field(DESC, "(Gradients) Concentration A")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.F CP")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:A")
}

record(ao, "$(P)CON:A:SP") {
	field(DESC, "(Gradients) Concentration A")
	field(EGU, "")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:A:SP PP")
}

alias("$(P)CON:A", "$(P)CON:A:SP:RBV")

record(ai, "$(P)CON:B") {
	field(DESC, "(Gradients) Concentration B")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.G CP")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:B")
}

record(ao, "$(P)CON:B:SP") {
	field(DESC, "(Gradients) Concentration B")
	field(EGU, "")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:B:SP PP")
}

alias("$(P)CON:B", "$(P)CON:B:SP:RBV")

record(ai, "$(P)CON:C") {
	field(DESC, "(Gradients) Concentration C")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.H CP")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:C")	
	info(INTEREST, "HIGH")
	
}

record(ao, "$(P)CON:C:SP") {
	field(DESC, "(Gradients) Concentration C")
	field(EGU, "")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:C:SP PP")
}

alias("$(P)CON:C", "$(P)CON:C:SP:RBV")

record(ai, "$(P)CON:D") {
	field(DESC, "(Gradients) Concentration D")
	field(EGU, "")
	
	field(INP, "$(P)BUFFER.I CP")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:D")
}

record(ao, "$(P)CON:D:SP") {
	field(DESC, "(Gradients) Concentration D")
	field(EGU, "")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
	field(SIOL, "$(P)SIM:CON:D:SP PP")
}

alias("$(P)CON:D", "$(P)CON:D:SP:RBV")

###########################################################
# PRESSURE LIMITS and current pressure
###########################################################

# ///
# /// The current pressure returned from the status command.
# ///
record(ai, "$(P)PRESSURE") {
	field(DESC, "Current pressure in kPa")
	field(EGU, "kPa")
	
	field(INP, "$(P)BUFFER.J CP")
	
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESSURE")
	
	info(INTEREST, "HIGH")
}

# /// Get the pressure limits currently set on the device.
record(ai, "$(P)GET_PRESS:LIM") {
	field(DESC, "Gets pressure low/high limits")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_plim($(P)PRESS:LOW,$(P)PRESS:HIGH) $(PORT)")
	field(EGU, "kPa")
}

record(ai, "$(P)PRESS:LOW") {
	field(DESC, "Low pressure limit")
	
	field(EGU, "kPa")

	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:LOW")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)PRESS:LOW:SP") {
	field(DESC, "Sets the low pressure limit")
	field(DTYP, "stream")
	
	field(OUT,  "@knr1050.proto set_plim_low($(P)PRESS:HIGH) $(PORT)")
	field(FLNK, "$(P)GET_PRESS:LIM")
	field(EGU, "kPa")

	field(DISV, "0")
	field(SDIS, "$(P)DISABLE")
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:LOW:SP PP")
	
	info(INTEREST, "HIGH")
}

alias("$(P)PRESS:LOW", "$(P)PRESS:LOW:SP:RBV")

record(ai, "$(P)PRESS:HIGH") {
	field(DESC, "High pressure limit")
	
	field(EGU, "kPa")
	
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:HIGH")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)PRESS:HIGH:SP") {
	field(DESC, "Sets the high pressure limit")
	field(DTYP, "stream")
	
	field(OUT,  "@knr1050.proto set_plim_high($(P)PRESS:LOW) $(PORT)")
	field(FLNK, "$(P)GET_PRESS:LIM")
	field(EGU, "kPa")
	
	field(DISV, "0")
	field(SDIS, "$(P)DISABLE")
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:HIGH:SP PP")
	
	info(INTEREST, "HIGH")
}

alias("$(P)PRESS:HIGH", "$(P)PRESS:HIGH:SP:RBV")

record(bi, "$(P)ERR_IN") {
	field(DESC, "Error input value")
	field(ZNAM, "OFF")
    field(ONAM, "ON")
	
	field(INP, "$(P)BUFFER.K CP")
	
	info(INTEREST, "HIGH")
}

### SIMULATION RECORDS ###

record(ao, "$(P)SIM:FLOW") {
	field(SCAN, "Passive")
	field(DTYP, "Soft Channel")
}

alias("$(P)SIM:FLOW", "$(P)SIM:FLOW:SP")
alias("$(P)SIM:FLOW", "$(P)SIM:FLOW:SP:RBV")

record(ao, "$(P)SIM:CON:A") {
	field(SCAN, "Passive")
	field(DTYP, "Soft Channel")
}

alias("$(P)SIM:CON:A", "$(P)SIM:CON:A:SP")
alias("$(P)SIM:CON:A", "$(P)SIM:CON:A:SP:RBV")

record(ao, "$(P)SIM:CON:B") {
	field(SCAN, "Passive")
	field(DTYP, "Soft Channel")
}

alias("$(P)SIM:CON:B", "$(P)SIM:CON:B:SP")
alias("$(P)SIM:CON:B", "$(P)SIM:CON:B:SP:RBV")

record(ao, "$(P)SIM:CON:C") {
	field(SCAN, "Passive")
	field(DTYP, "Soft Channel")
}

alias("$(P)SIM:CON:C", "$(P)SIM:CON:C:SP")
alias("$(P)SIM:CON:C", "$(P)SIM:CON:C:SP:RBV")

record(ao, "$(P)SIM:CON:D") {
	field(SCAN, "Passive")
	field(DTYP, "Soft Channel")
}

alias("$(P)SIM:CON:D", "$(P)SIM:CON:D:SP")
alias("$(P)SIM:CON:D", "$(P)SIM:CON:D:SP:RBV")

record(ai, "$(P)SIM:PRESSURE") {
	field(FLNK, "$(P)PRESSURE")
}

record(ao, "$(P)SIM:PRESS:LOW") {
    field(FLNK, "$(P)PRESS:LOW")
}

alias("$(P)SIM:PRESS:LOW", "$(P)SIM:PRESS:LOW:SP")
alias("$(P)SIM:PRESS:LOW", "$(P)SIM:PRESS:LOW:SP:RBV")


record(ao, "$(P)SIM:PRESS:HIGH") {
    field(FLNK, "$(P)PRESS:HIGH")
}

alias("$(P)SIM:PRESS:HIGH", "$(P)SIM:PRESS:HIGH:SP")
alias("$(P)SIM:PRESS:HIGH", "$(P)SIM:PRESS:HIGH:SP:RBV")

