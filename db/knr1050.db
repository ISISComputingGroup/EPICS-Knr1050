record(bo, "$(P)SIM") {
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
    field(VAL, "$(RECSIM=0)")
}

###########################################################
# Remote/Local mode control
###########################################################

# ///
# /// The device can be in a local or remote mode. If in local
# /// mode then the front panel can be accessed but no commands
# /// can be remotely executed accept for switching to remote
# /// and checking the current remote/local state. If in remote
# /// mode then remotely executed commands are accepted but the
# /// front panel of the device is unavilable.
# ///
record(mbbo, "$(P)TOGGLE:REMOTE:SP") {
	field(DESC, "Toggle remote/local mode")
    field(DTYP, "Raw Soft Channel")

	field(OUT, "$(P)_TOGGLE:REMOTE.SELN PP")
	
	field(ZRVL, "1")
	field(ONVL, "2")
	
	field(ZRST, "Local mode")
	field(ONST, "Remote mode")

	info(INTEREST, "HIGH")
}

record(fanout, "$(P)_TOGGLE:REMOTE") {
	field(SELM, "Specified")
	
	field(LNK1, "$(P)_LOCAL_MODE:SP PP")
	field(LNK2, "$(P)_REMOTE_MODE:SP PP")
}

record(bo, "$(P)_REMOTE_MODE:SP") {
	field(DESC, "Set the device into remote/local mode")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto set_remote_mode() $(PORT)")
}

record(bo, "$(P)_LOCAL_MODE:SP") {
	field(DESC, "Sets the device into local mode")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto set_local_mode() $(PORT)")
}

record(bi, "$(P)GET_REMOTE_MODE") {
	field(DESC, "Gets the current remote state")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_remote_mode($(P)REMOTE_MODE) $(PORT)")
}

record(bi, "$(P)REMOTE_MODE") {
	field(DESC, "Current remote/local mode state")
	
	field(ZNAM, "LOCAL MODE")
	field(ONAM, "REMOTE MODE")
	
	info(INTEREST, "HIGH")
}


###########################################################
# Toggle the pump to either begin or stop a run
###########################################################

# ///
# /// The toggle pump set point will either begin a run or stop a run.
# /// This involves either sending an appropriate ramp AND stop command
# /// to the device to begin, or the appropriate stop command to end.
# /// As a result this single set point uses a fanout and link to 
# /// ensure these commands are correctly sent.
# ///
record(mbbo, "$(P)TOGGLE:PUMP:SP") {
	field(DESC, "Start or stop the pump")
    field(DTYP, "Raw Soft Channel")

	field(OUT, "$(P)_TOGGLE:SELECT.SELN PP")
	
	field(ZRVL, "1")
	field(ONVL, "2")
	
	field(ZRST, "Stop pump")
	field(ONST, "Start pump")
	
	info(INTEREST, "HIGH")
}

# ///
# /// For the given toggle pump set point process the desired record.
# ///
record(fanout, "$(P)_TOGGLE:SELECT") {
	field(SELM, "Specified")
	
	field(LNK1, "$(P)_STOP_PUMP:SP PP")
	field(LNK2, "$(P)_RAMP:SP PP")
}

record(bo, "$(P)_STOP_PUMP:SP") {
	field(DESC, "Stops the ramp")
	field(DTYP, "stream")
	field(SCAN, "Passive")
	
	field(OUT,  "@knr1050.proto stop_pump $(PORT)")
	
	info(INTEREST, "HIGH")
}

record(bo, "$(P)_STOP:KLV:SP") {
	field(DESC, "Stop mode: keep last values")
	field(DTYP, "stream")

	field(OUT,  "@knr1050.proto stop_klv $(PORT)")
	
	info(INTEREST, "HIGH")
}

alias("$(P)_STOP:KLV:SP", "$(P)_STOP:KLV")

record(bo, "$(P)_RAMP:SP") {
	field(DESC, "Starts the ramp")
	field(DTYP, "stream")
    field(SCAN, "Passive")
	
	field(OUT, "@knr1050.proto ramp($(P),_FLOW:SP:CONV,CON:A:SP,CON:B:SP,CON:C:SP,CON:D:SP) $(PORT)")

	field(FLNK, "$(P)_STOP:KLV:SP PP")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
}

alias("$(P)_RAMP:SP", "$(P)_RAMP")

# ///
# /// Get the pressure limits currently set on the device.
# ///
record(ai, "$(P)GET_PRESS:LIM") {
	field(DESC, "Gets pressure low/high limits")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_plim($(P)PRESS:LOW,$(P)PRESS:HIGH) $(PORT)")
	field(EGU, "KPa")
}

record(ai, "$(P)PRESS:LOW") {
	field(DESC, "Low pressure limit")
	
	field(EGU, "kPa")

	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:LOW")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)PRESS:LOW:SP") {
	field(DESC, "Sets the low pressure limit")
	field(DTYP, "stream")
	
	field(OUT,  "@knr1050.proto set_plim_low($(P)PRESS:HIGH) $(PORT)")
	field(FLNK, "$(P)GET_PRESS:LIM")
	field(EGU, "KPa")

	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:LOW:SP PP")
	
	info(INTEREST, "HIGH")
}

alias("$(P)PRESS:LOW", "$(P)PRESS:LOW:SP:RBV")


record(ai, "$(P)PRESS:HIGH") {
	field(DESC, "High pressure limit")
	
	field(EGU, "kPa")
	
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:HIGH")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)PRESS:HIGH:SP") {
	field(DESC, "Sets the high pressure limit")
	field(DTYP, "stream")
	
	field(OUT,  "@knr1050.proto set_plim_high($(P)PRESS:LOW) $(PORT)")
	field(FLNK, "$(P)GET_PRESS:LIM")
	field(EGU, "KPa")
	
	info(INTEREST, "HIGH")
	field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:PRESS:HIGH:SP PP")
	
	info(INTEREST, "HIGH")
}

alias("$(P)PRESS:HIGH", "$(P)PRESS:HIGH:SP:RBV")

###########################################################
# Get the device status
###########################################################

# ///
# /// The status is sent to a calc record buffer. The records
# /// that relate to the status returns are then populated
# /// using the buffer elements. 
# ///
record(ai, "$(P)GET_STATUS") {
	field(DESC, "Get the current device status")
	field(DTYP, "stream")
	field(SCAN, "1 second")
	
	field(INP, "@knr1050.proto get_status($(P)BUFFER) $(PORT)")
}

# ///
# /// For storing the parsed values of get_status
# ///
record(calc, "$(P)BUFFER") {
	field(CALC, "0")
}

record(ai, "$(P)TIMESTAMP") {
	field(DESC, "Device timestamp in ms")
	
	field(INP, "$(P)BUFFER.A CP")
	
	info(INTEREST, "HIGH")
}

record(mbbi, "$(P)INST_STATE") {
    field(DESC, "The current instrument state.")

	field(INP, "$(P)BUFFER.B CP")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
	field(FRVL, "5")
    field(FRVL, "6")   
	
    field(ZRST, "SYS_ST_INITIALIZING")
    field(ONST, "SYS_ST_OFF")
    field(TWST, "SYS_ST_IDLE")
    field(THST, "SYS_ST_RUN")
    field(FRST, "SYS_ST_HOLD")
    field(FVST, "SYS_ST_PURGE")
    field(SXST, "SYS_ST_STANDBY")
    
    info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR_ERR") {
	field(DESC, "Current error")
	
	field(INP, "$(P)BUFFER.C CP")
	
	info(INTEREST, "HIGH")
}

record(ai, "$(P)CURR_PG_RT") {
	field(DESC, "Current program run time")
	
	field(INP, "$(P)BUFFER.D CP")
	
	info(INTEREST, "HIGH")
}

# ///
# /// Convert the flowrate from ul/Min to ml/min
record(calcout, "$(P)_FLOW:CONV") {
	field(INPA, "$(P)BUFFER.E CP")
	field(CALC, "A * 1000")
	
	field(OUT, "$(P)FLOW")
}

# ///
# /// Convert the flowrate setpoint from ml/Min to ul/min
record(calc, "$(P)_FLOW:SP:CONV") {
	field(INPA, "$(P)FLOW:SP CP")
	field(CALC, "A / 1000")
}

record(ai, "$(P)FLOW") {
	field(DESC, "Current flow rate")
	field(EGU, "ml/min")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)FLOW:SP") {
	field(DESC, "Desired flow rate")
	field(EGU, "ul/min")
	
	info(INTEREST, "HIGH")
}

alias("$(P)FLOW", "$(P)FLOW:SP:RBV")

record(ai, "$(P)CON:A") {
	field(DESC, "(Gradients) Concentration A")
	
	field(INP, "$(P)BUFFER.F CP")
	
	info(INTEREST, "HIGH")
}

###########################################################
# Calculate the sum of the concentration gradients
###########################################################

# ///
# /// Here we calculate the sum of the 4 concentration gradients
# /// and if they exceed 100% then the ramp set point is disabled.
# /// This allows the user to stop the pump even if the current
# /// gradient set points are invalid. 
# ///
record(calcout, "$(P)CON:SUM") {
	field(SCAN, "Passive")
	
	field(INPA, "$(P)CON:A:SP CP")
	field(INPB, "$(P)CON:B:SP CP")
	field(INPC, "$(P)CON:C:SP CP")
	field(INPD, "$(P)CON:D:SP CP")
	
	field(OUT, "$(P)_RAMP:SP.DISA")

	field(CALC, "(A+B+C+D)=100?0:1")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)CON:A:SP") {
	field(DESC, "(Gradients) Concentration A")
	
	info(INTEREST, "HIGH")
}

alias("$(P)CON:A", "$(P)CON:A:SP:RBV")

record(ai, "$(P)CON:B") {
	field(DESC, "(Gradients) Concentration B")
	
	field(INP, "$(P)BUFFER.G CP")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)CON:B:SP") {
	field(DESC, "(Gradients) Concentration B")
	
	info(INTEREST, "HIGH")
}

alias("$(P)CON:B", "$(P)CON:B:SP:RBV")

record(ai, "$(P)CON:C") {
	field(DESC, "(Gradients) Concentration C")
	
	field(INP, "$(P)BUFFER.H CP")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)CON:C:SP") {
	field(DESC, "(Gradients) Concentration C")
	
	info(INTEREST, "HIGH")
}

alias("$(P)CON:C", "$(P)CON:C:SP:RBV")

record(ai, "$(P)CON:D") {
	field(DESC, "(Gradients) Concentration D")
	
	field(INP, "$(P)BUFFER.I CP")
	
	info(INTEREST, "HIGH")
}

record(ao, "$(P)CON:D:SP") {
	field(DESC, "(Gradients) Concentration D")
	
	info(INTEREST, "HIGH")
}

alias("$(P)CON:D", "$(P)CON:D:SP:RBV")

record(ai, "$(P)PRESSURE") {
	field(DESC, "Pressure in kPa")
	
	field(INP, "$(P)BUFFER.J CP")
	
	info(INTEREST, "HIGH")
}

record(bi, "$(P)ERR_IN") {
	field(DESC, "Error input value")
	field(ZNAM, "OFF")
    field(ONAM, "ON")
	
	field(INP, "$(P)BUFFER.K CP")
	
	info(INTEREST, "HIGH")
}

### SIMULATION RECORDS ###

record(ao, "$(P)SIM:PRESS:LOW") {
    field(FLNK, "$(P)PRESS:LOW")
}

alias("$(P)SIM:PRESS:LOW", "$(P)SIM:PRESS:LOW:SP")
alias("$(P)SIM:PRESS:LOW", "$(P)SIM:PRESS:LOW:SP:RBV")


record(ao, "$(P)SIM:PRESS:HIGH") {
    field(FLNK, "$(P)PRESS:HIGH")
}

alias("$(P)SIM:PRESS:HIGH", "$(P)SIM:PRESS:HIGH:SP")
alias("$(P)SIM:PRESS:HIGH", "$(P)SIM:PRESS:HIGH:SP:RBV")

record(ao, "$(P)SIM:FLOWRATE") {
	field(FLNK, "$(P)FLOWRATE")
}

alias("$(P)SIM:FLOWRATE", "$(P)SIM:FLOWRATE:SP")
alias("$(P)SIM:FLOWRATE", "$(P)SIM:FLOWRATE:SP:RBV")